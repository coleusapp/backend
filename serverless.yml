service: coleus

provider:
  name: aws
  region: us-east-1
  stage: production
  runtime: provided
  environment:
    APP_ENV: production
    APP_DEBUG: true
    APP_KEY: "base64:GNfPMO7D5CmTP3ZTwTX8iznKJEHb9rHyFjhlxcern9c="
  vpc:
    securityGroupIds:
      - sg-f012a9a8
    subnetIds:
      - subnet-37101638
      - subnet-d9392593
      - subnet-eb672eb7
      - subnet-67682349
      - subnet-5a74e464
      - subnet-f5276b92

package:
  exclude:
    - node_modules/**
    - public/storage
    - resources/assets/**
    - storage/**
    - tests/**

functions:
  web:
    handler: public/index.php
    timeout: 28
    layers:
      - ${bref:layer.php-74-fpm}
    events:
      - http: "ANY /"
      - http: "ANY /{proxy+}"
  artisan:
    handler: artisan
    timeout: 120
    layers:
      - ${bref:layer.php-74}
      - ${bref:layer.console}

plugins:
  - ./vendor/bref/bref

resources:
  Resources:
    WebsiteCDN:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Enabled: true
          # Cheapest option by default (https://docs.aws.amazon.com/cloudfront/latest/APIReference/API_DistributionConfig.html)
          PriceClass: PriceClass_100
          # Enable http2 transfer for better performances
          HttpVersion: http2
          # Origins are where CloudFront fetches content
          Origins:
            # The website (AWS Lambda)
            - Id: Website
              DomainName:
                !Join [
                  ".",
                  [
                    !Ref ApiGatewayRestApi,
                    "execute-api",
                    !Ref AWS::Region,
                    "amazonaws.com",
                  ],
                ]
              # This is the stage
              OriginPath: "/${opt:stage, 'dev'}"
              CustomOriginConfig:
                OriginProtocolPolicy: "https-only" # API Gateway only supports HTTPS
            # The assets (S3)
            - Id: Assets
              DomainName: !GetAtt Assets.RegionalDomainName
              S3OriginConfig: {} # this key is required to tell CloudFront that this is an S3 origin, even though nothing is configured
              # If you host a static website, like a SPA, use s3-website URLs instead of the config above
              # See https://stackoverflow.com/questions/15309113/amazon-cloudfront-doesnt-respect-my-s3-website-buckets-index-html-rules#15528757
              # DomainName: !Select [2, !Split ["/", !GetAtt Assets.WebsiteURL]]
              # CustomOriginConfig:
              #     OriginProtocolPolicy: 'http-only' # S3 websites only support HTTP
              # You'll also need to enable website hosting on your s3 bucket by configuring the WebsiteConfiguration property
              # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-bucket.html#cfn-s3-bucket-websiteconfiguration
          # The default behavior is to send everything to AWS Lambda
          DefaultCacheBehavior:
            AllowedMethods: [GET, HEAD, OPTIONS, PUT, POST, PATCH, DELETE]
            TargetOriginId: Website # the PHP application
            # Disable caching for the PHP application https://aws.amazon.com/premiumsupport/knowledge-center/prevent-cloudfront-from-caching-files/
            DefaultTTL: 0
            MinTTL: 0
            MaxTTL: 0
            # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cloudfront-distribution-forwardedvalues.html
            ForwardedValues:
              QueryString: true
              Cookies:
                Forward: all # Forward cookies to use them in PHP
              # We must *not* forward the `Host` header else it messes up API Gateway
              Headers:
                - "Accept"
                - "Accept-Language"
                - "Origin"
                - "Referer"
            ViewerProtocolPolicy: redirect-to-https
          CustomErrorResponses:
            # Do not cache HTTP errors
            - ErrorCode: 500
              ErrorCachingMinTTL: 0
            - ErrorCode: 504
              ErrorCachingMinTTL: 0
